@{
    ViewBag.Title = "CloudTxt - Collaborative Editor";
}

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>CloudTxt - Collaborative Editor</title>
    <!-- Using CDN for jQuery and SignalR client library without integrity attributes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .editor-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-size: 14px;
        }
        .group-box {
            margin-bottom: 10px;
        }
        .group-box input[type="text"] {
            width: 200px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <h1>CloudTxt - Collaborative Editor</h1>
        <div class="group-box">
            <label for="groupName">Group Name:</label>
            <input type="text" id="groupName" value="myGroup" />
            <button id="joinGroupBtn">Join Group</button>
        </div>
        <!-- Set the initial document content from the database -->
        <textarea id="editor" placeholder="Start typing...">@ViewBag.DocumentContent</textarea>
    </div>

    <script>
        // Create the SignalR connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/collabHub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // When the server sends a text update, update the text area.
        connection.on("ReceiveText", function (newText) {
            $('#editor').val(newText);
        });

        // Start the SignalR connection.
        connection.start()
            .then(function () {
                console.log("SignalR connected!");
            })
            .catch(function (err) {
                console.error(err.toString());
            });

        // Join the group when the button is clicked.
        $('#joinGroupBtn').click(function () {
            const groupName = $('#groupName').val();
            connection.invoke("JoinGroup", groupName)
                .then(function () {
                    alert('Joined group: ' + groupName);
                })
                .catch(function (err) {
                    console.error(err.toString());
                });
        });

        // Send text updates on every input event.
        $('#editor').on('input', function () {
            const groupName = $('#groupName').val();
            const newText = $(this).val();
            connection.invoke("UpdateText", groupName, newText)
                .catch(function (err) {
                    console.error(err.toString());
                });
        });
    </script>
</body>
</html>
